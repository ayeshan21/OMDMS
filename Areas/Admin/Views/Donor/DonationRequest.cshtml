@model Online_Medicine_Donation.ViewModel.RequestVM
@{
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewData["Title"] = "Donation Request Form";
}
<form id="medicineForm" method="post" enctype="multipart/form-data" asp-controller="Donor" asp-action="DonationRequest">
    <div class="p-4 bg-light">
        <div class="form-group">
            <label asp-for="Name" class="control-label">Medicine Full Name *</label>
            <input asp-for="donationRequest.Name" class="form-control" id="medName" />
            <span asp-validation-for="Name" class="text-danger"></span>
        </div>
        <div class="form-group">
            <label asp-for="Quantity" class="control-label"> Medicine Quantity *</label>
            <input asp-for="donationRequest.Quantity" class="form-control" type="number" min="1" id="quantity" />
            <span asp-validation-for="Quantity" class="text-danger"></span>
        </div>
        <div class="form-group">
            <label asp-for="Company" class="control-label">Pharmaceutical Company</label>
            <input asp-for="donationRequest.Company" class="form-control" type="text" id="company" />
            <span asp-validation-for="Company" class="text-danger"></span>
        </div>
        <div class="form-group">
            <label asp-for="Type" class="control-label">Medicine Type</label>
            <select asp-for="donationRequest.Type" class="form-control" id="type">
                <option value="Tablet">Tablet</option>
                <option value="Capsule">Capsule</option>
                <option value="Syrup">Syrup</option>
                <option value="Ointment">Ointment</option>
                <option value="Injection">Injection</option>
            </select>
            <span asp-validation-for="Type" class="text-danger"></span>
        </div>
        <div class="form-group">
            <label asp-for="ExpiryDate" class="control-label">Expiry Date *</label>
            <input asp-for="donationRequest.ExpiryDate" class="form-control" type="date" id="expiryDate" />
            <span asp-validation-for="ExpiryDate" class="text-danger"></span>
        </div>
        <div class="form-group">
            <label asp-for="Condition" class="control-label">Medicine Condition *</label>
            <select asp-for="donationRequest.Condition" class="form-control" id="condition">
                <option value="Sealed">Sealed</option>
                <option value="Opened">Opened</option>
            </select>
            <span asp-validation-for="Condition" class="text-danger"></span>
        </div>
        <div class="form-group">
            <label asp-for="SelectNgo" class="control-label">Select NGO *</label>
            <select asp-for="donationRequest.SelectNgo" class="form-control" id="selectNgo">
                <option value="">-- Select NGO --</option>
                @foreach (var item in Model.NgoList)
                {
                    <option value="@item.FullName">@item.FullName</option>
                }
            </select>
            <span asp-validation-for="SelectNgo" class="text-danger"></span>
        </div>
        <div class="form-group">
            <!-- Changed to use asp-for="PhotoFile" instead of name="photo" to match the model property -->
            <label asp-for="PhotoFile" class="control-label">Medicine Photo *</label>
            <input type="file" asp-for="PhotoFile" class="form-control-file" id="medicinePhoto" name="PhotoFile" />
            <span asp-validation-for="PhotoFile" class="text-danger"></span>
        </div>
        <div class="form-group d-flex justify-content-between">
            <input type="submit" value="Send request for donation" class="btn btn-success" id="submitMedicine" name="submitmedicine" asp-controller="Donor" asp-action="DonationRequest" />
        </div>
    </div>
</form>
@section Scripts
{
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        $(document).ready(function () {
            $("#submitMedicine").click(function (event) {
                event.preventDefault();

                var formdata = new FormData();
                formdata.append("donationRequest.Name", $("#medName").val());
                formdata.append("donationRequest.Quantity", $("#quantity").val());
                formdata.append("donationRequest.Company", $("#company").val());
                formdata.append("donationRequest.Type", $("#type").val());
                formdata.append("donationRequest.ExpiryDate", $("#expiryDate").val());
                formdata.append("donationRequest.Condition", $("#condition").val());
                formdata.append("donationRequest.SelectNgo", $("#selectNgo").val());

                var fileInput = $("#medicinePhoto")[0];
                if (fileInput.files.length > 0) {
                    // Changed to "PhotoFile" to match the MedicineVM property that receives the file
                    formdata.append("PhotoFile", fileInput.files[0]);
                }
                // Debug: log FormData contents
                for (var pair of formdata.entries()) {
                    console.log(pair[0] + ': ' + (pair[0] === 'PhotoFile' ? pair[1].name : pair[1]));
                }
                $.ajax({
                    url: "/Donor/CreateMedicine",
                    type: "POST",
                    data: formdata,
                    contentType: false,
                    processData: false,
                    success: function (response) {
                        Swal.fire({
                            title: "Saved!",
                            icon: "success"
                        });
                    },
                    error: function (xhr, status, error) {
                        console.error("Error details:", xhr.responseText);
                        Swal.fire({
                            title: "Error",
                            text: xhr.responseText || "Something went wrong!",
                            icon: "error"
                        });
                    }
                });
            });
        });
    </script>
}